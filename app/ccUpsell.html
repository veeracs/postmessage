<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>  
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title><TMPL_IF TITLE><TMPL_VAR NAME="TITLE"><TMPL_ELSE><TMPL_VAR NAME="SITE_NAME"></TMPL_IF></title>
    <meta name="description" content="<TMPL_VAR NAME='META_DESCRIPTION'>">
    <meta name="keywords" content="<TMPL_VAR NAME='META_KEYWORDS'>">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://stag-cnid.condenastdigital.com/client/css/main.css">
    <style>
      .container-fluid {
        margin: 0 30px;
        padding-bottom: 10px;
        top: 0;
      }
      select {
        width: 100px;
      }
      a.lnk-conde {
        padding-left: 20px;
        text-decoration: underline;
      }
      input[type="radio"] {
        margin-top: 10px;
      }
      @media only screen and (min-width : 310px) and (max-width : 511px) {
        .row-fluid .radio-set {
          clear: both;
          padding-top: 20px;
        }
        .row-fluid .radio-unit {
          float: left;
          display: block;
          width: 68px;
        }
        .container-fluid {
          margin: 0 10px;
          padding-bottom: 0px;
          top: 0;
        }
      }
    </style>
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <script src="https://ci-cnid.conde.io/components/json2/json2.js"></script>
    <![endif]-->
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
  </head>
<body>

<div class="container-fluid">
  <div class="row-fluid span12">
        <TMPL_IF error><div id="errorMessage" class="alert alert-error server-error cn-server-error"><TMPL_VAR NAME="error"></div></TMPL_IF>
  </div>
  <form name="subscription" action="/subscribe/processSubscription" method="post">
    <!-- V2 needs the trans key to identify the orig trans, and the offer_id of the _container_ -->
    <TMPL_IF EXPR="host_ind >=1">
      <input type="hidden" name="offer_id" value="<TMPL_VAR NAME='OFFER_ID'>">
      <input type=hidden name="trans_key" value="<TMPL_VAR NAME='TRANS_KEY'>">
      <TMPL_LOOP NAME="UPSELLS">
          <input type="hidden" name="offer_term" value="<TMPL_VAR NAME='OFFER_TERM_ID'>">
      </TMPL_LOOP>
    <TMPL_ELSE>
      <!-- V1 needs the offer_id of the upsell itself -->
      <TMPL_LOOP NAME="UPSELLS">
        <input type="hidden" name="offer_id" value="<TMPL_VAR NAME='OFFER_ID'>">
        <input type="hidden" name="offer_term" value="<TMPL_VAR NAME='OFFER_TERM'>">
      </TMPL_LOOP>
    </TMPL_IF>
    <input type="hidden" name="host_offer_id" value="<TMPL_VAR NAME='HOST_OFFER_ID'>" id="host_offer_id">
    <input type="hidden" name="referral_source" value="<TMPL_VAR NAME='SOURCE'>" />
    <input type="hidden" name="previous_page" value="<TMPL_VAR NAME='PREVIOUS_PAGE'>" id="previous_page">
    <input type="hidden" name="parent_trans_id" value="<TMPL_VAR NAME='TRANS1_TRANS_ID'>">
    <input type="hidden" name="source_code" value="<TMPL_VAR NAME='SOURCE_CODE'>">
    <input type="hidden" name="first_name" value="<TMPL_VAR NAME='TRANS1_FIRST_NAME'>">
    <input type="hidden" name="last_name" value="<TMPL_VAR NAME='TRANS1_LAST_NAME'>">
    <input type="hidden" name="address" value="<TMPL_VAR NAME='TRANS1_ADDRESS'>">
    <input type="hidden" name="address2" value="<TMPL_VAR NAME='TRANS1_ADDRESS2'>">
    <input type="hidden" name="city" value="<TMPL_VAR NAME='TRANS1_CITY'>">
    <input type="hidden" name="state" value="<TMPL_VAR NAME='TRANS1_STATE'>">
    <input type="hidden" name="postal_code" value="<TMPL_VAR NAME='TRANS1_POSTAL_CODE'>">
    <input type="hidden" name="country_code" value="<TMPL_VAR NAME='TRANS1_COUNTRY_CODE'>">
    <input type="hidden" name="email" value="<TMPL_VAR NAME='TRANS1_EMAIL'>">
    <input type="hidden" name="ship_first_name" value="<TMPL_VAR NAME='TRANS1_SHIP_FIRST_NAME'>">
    <input type="hidden" name="ship_last_name" value="<TMPL_VAR NAME='TRANS1_SHIP_LAST_NAME'>">
    <input type="hidden" name="ship_address" value="<TMPL_VAR NAME='TRANS1_SHIP_ADDRESS'>">
    <input type="hidden" name="ship_address2" value="<TMPL_VAR NAME='TRANS1_SHIP_ADDRESS2'>">
    <input type="hidden" name="ship_city" value="<TMPL_VAR NAME='TRANS1_SHIP_CITY'>">
    <input type="hidden" name="ship_state" value="<TMPL_VAR NAME='TRANS1_SHIP_STATE'>">
    <input type="hidden" name="ship_postal_code" value="<TMPL_VAR NAME='TRANS1_SHIP_POSTAL_CODE'>">
    <input type="hidden" name="ship_country_code" value="<TMPL_VAR NAME='TRANS1_SHIP_COUNTRY_CODE'>">
    <input type="hidden" name="ship_email" value="<TMPL_VAR NAME='TRANS1_SHIP_EMAIL'>">
    <input type="hidden" name="general_optin" value="<TMPL_VAR NAME='TRANS1_GENERAL_OPTIN'>">
    <input type="hidden" name="secondary_optin" value="<TMPL_VAR NAME='TRANS1_SECONDARY_OPTIN'>">
    <input type="hidden" name="edialog_list_id" value="<TMPL_VAR NAME='EDIALOG_LIST_ID'>">
    <input type="hidden" name="se_id" value="<TMPL_VAR NAME='SE_ID'>">
    <input type="hidden" name="ur_id" value="<TMPL_VAR NAME='UR_ID'>">
    <input type="hidden" name="user_name" value="<TMPL_VAR NAME='USER_NAME'>">
    <input type="hidden" name="password" value="<TMPL_VAR NAME='PASSWORD'>">
    <input type="hidden" name="pos_name" value="<TMPL_VAR NAME='POS_NAME'>" />
    <input type="hidden" name="segment_name" value="<TMPL_VAR NAME='CRITERIA_NAME'>" />
    <TMPL_LOOP NAME="UPSELL_PREMIUMS">
      <input type="hidden" name="premium_id" value="<TMPL_VAR NAME='PREMIUM_ID'>">
    </TMPL_LOOP>
    <div class="span12 subunit bottom-shadow subunit-shadow">
      <p>Thank you for your order! Pay now to take adavantage of this offer orem ipsum dolor sit amet, consectetur adipisicing elit.</p>
      <div class="row-fluid">
        <div class="span3">
          <img class="mag-cover" src="https://subscribe.condenet.com/images_covers/cover_glamour_146.jpg" alt="magazine cover">  
        </div>
        <div class="span9">
          <div class="row-fluid">
            <div class="span12">
              <div class="row-fluid  spacing-btm20">
                <div class="control-group text-center radio-set">
                  <div class="span3 radio-unit">
                    <div><label for="visaCard"><img src="https://stag-cnid.condenastdigital.com/client/assets/img/visa.png" alt=""></label></div>
                    <input id="visaCard" name="pt_id" type="radio" class="radio" value="2">
                  </div>
                  <div class="span3 radio-unit">
                    <div><label for="masterCard"><img src="https://stag-cnid.condenastdigital.com/client/assets/img/mastercard.png" alt=""></label></div>
                    <input id="masterCard" name="pt_id" type="radio" class="radio" value="1">
                  </div>
                  <div class="span3 radio-unit">
                    <div><label for="amexCard"><img src="https://stag-cnid.condenastdigital.com/client/assets/img/amex.png" alt=""></label></div>
                    <input id="amexCard" name="pt_id" type="radio" class="radio" value="3">
                  </div>
                  <div class="span3 radio-unit">
                    <div><label for="discoverCard"><img src="https://stag-cnid.condenastdigital.com/client/assets/img/discover.png" alt=""></label></div>
                    <input id="discoverCard" name="pt_id" type="radio" class="radio" value="5">
                  </div>
                </div>
              </div>
              <div id="inline-error-credit-type" class="alert alert-error form-alert cn-alert-error hide"><div class="cn-alert-error-arrow-up"></div>Not a valid credit card type!</div>
              <div class="row-fluid">
                <div class="control-group">
                  <label for="">Credit Card Number</label>
                  <input name="credit_card_number" type="text" class="ccnumb" id="credit_card_number" maxlength="24" placeholder="Credit Card Number*">
                  <div id="inline-error-credit-card" class="alert alert-error form-alert cn-alert-error hide"><div class="cn-alert-error-arrow-up"></div>Not a valid credit card number!</div>
                </div>
              </div>
              <div class="row-fluid">
                <div class="control-group">
                  <label for="">Expiration Date</label>
                  <div class="row-fluid">
                    <div class="span12">
                      <select class="mm" name="credit_card_exp_month">
                        <option value="01">1</option><option value="02">2</option><option value="03">3</option><option value="04">4</option><option value="05">5</option><option value="06">6</option><option value="07">7</option><option value="08">8</option><option value="09">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                      </select>
                      <select class="yy" name="credit_card_exp_year">
                        <option value="13">2013</option><option value="14">2014</option><option value="15">2015</option><option value="16">2016</option><option value="17">2017</option><option value="18">2018</option><option value="19">2019</option><option value="20">2020</option><option value="21">2021</option><option value="22">2022</option><option value="23">2023</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row-fluid">
                <div class="control-group">
                  <button id="submitPayment" class="btn-form btn-conde" type="button">Submit</button>
                  <img class="hide" src="/circulation/shared/images/omn_processing.gif" id="standby">
                  <a id="billMeLater" class="lnk-conde" href="#">Bill me later</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="legal">
        <p><strong>Subscriber's Automatic Renewal Feature:</strong></p>
        <p>Your subscription will be automatically renewed unless you tell us to stop. Before the start of each renewal, you will be sent a reminder notice stating the term and rate in effect. If you do nothing, your credit/debit card will be charged or you will be sent an invoice for your subscription. You may cancel at any time during your subscription and receive a full refund for unmailed issues.</p>
        <p>Subscribers: If the Post Office alerts us that your magazine is undeliverable, we have no further obligation unless we receive a corrected address within one year. All orders subject to approval. By ordering, you agree not to resell any subscriptions purchased from this site.</p>
        <p>Plus sales tax where applicable.</p>
      </div>
      <TMPL_INCLUDE NAME="ssl.tmpl">
    </div>
  </form>
</div>
<!--script src="https://stag-cnid.condenastdigital.com/client/vendor/hearst.js"></script-->
<script>
(function(){
  
  var requestPayload = {next: true};

  $('#submitPayment').on('click', function(){
    console.log('submit clicked');
    if(validForm()) {
      console.log('Submitting form...');
      $("#previous_page").val('CCUPSELLACCEPT');
      $('#standby').show(); 
      document.subscription.submit();
    } else {
      console.log('form validation failed!');
      return false;
    }
    //  send the domain as query param
    //  window.location = 'http://ist-cveera-6065:5000/ccUpsellConfirm.html?domain=http://IST-cveera-6065:9001/';
  });

  //  post message to navigate to next view in the parent
  $('#billMeLater').on('click', function(){
    $('#previous_page').val('CCUPSELLDECLINE');
    $('#host_offer_id').val('');
    document.subscription.submit();
    //  parent.postMessage(JSON.stringify(requestPayload), getQueryParams('domain'));
  });

  //  post message to navigate to next view in the parent
  $('#continue').on('click', function(){
    console.log('continue clicked');
    parent.postMessage(JSON.stringify(requestPayload), getQueryParams('domain'));
  });

  //  validate the form inputs
  function validForm(){
    //  enable the button only when all fields are filled
    //  validate radio input
    //  initialize credt cards
    try {
      var pt_id = [];
          pt_id[1] = "MC", pt_id[2] = "Visa", pt_id[3] = "AmEx", pt_id[5] = "Disc";

      var radioChecked = cardValid = false;
      if ($('input[name=pt_id]:checked').val()) {
        $('#inline-error-credit-type').hide();
        radioChecked = true;
      } else {
        console.log('card type validation failed');
        $('#inline-error-credit-type').show();
      }
      if(isValidCreditCard(pt_id[$( "input:radio[name=pt_id]:checked" ).val()], $('#credit_card_number').val())) {
        $('#inline-error-credit-card').hide();
        cardValid = true;
      } else {
        console.log('credit card validation failed');
        $('#inline-error-credit-card').show();
      }
      if(radioChecked && cardValid) {
        return true;
      } else {
        return false;
      }
    } catch(e) {
      console.log(e.message);
    }
  }
  
  //  get query params
  function getQueryParams(param) {
    var queryStr = window.location.search.slice(1),
    params = queryStr.split('&');
    for(var i=0; i < params.length; i++){
      var pair = params[i].split('=');
      if(pair[0] === param) {
        return pair[1];
      }
    }
    return false;
  }
  //  validate credit card
  function isValidCreditCard(type, ccnum) {
    if (type == "Visa") {
      // Visa: length 16, prefix 4, dashes optional.
      var re = /^4\d{3}-?\d{4}-?\d{4}-?\d{4}$/;
    } else if (type == "MC") {
      // Mastercard: length 16, prefix 51-55, dashes optional.
      var re = /^5[1-5]\d{2}-?\d{4}-?\d{4}-?\d{4}$/;
    } else if (type == "Disc") {
      // Discover: length 16, prefix 6011, dashes optional.
      var re = /^6011-?\d{4}-?\d{4}-?\d{4}$/;
    } else if (type == "AmEx") {
      // American Express: length 15, prefix 34 or 37.
      var re = /^3[4,7]\d{13}$/;
    } else if (type == "Diners") {
      // Diners: length 14, prefix 30, 36, or 38.
      var re = /^3[0,6,8]\d{12}$/;
    }
    if (!re.test(ccnum)) return false;
    // Remove all dashes for the checksum checks to eliminate negative numbers
    ccnum = ccnum.split("-").join("");
    // Checksum ("Mod 10")
    // Add even digits in even length strings or odd digits in odd length strings.
    var checksum = 0;
    for (var i=(2-(ccnum.length % 2)); i<=ccnum.length; i+=2) {
      checksum += parseInt(ccnum.charAt(i-1));
    }
    // Analyze odd digits in even length strings or even digits in odd length strings.
    for (var i=(ccnum.length % 2) + 1; i<ccnum.length; i+=2) {
      var digit = parseInt(ccnum.charAt(i-1)) * 2;
      if (digit < 10) { checksum += digit; } else { checksum += (digit-9); }
    }
    if ((checksum % 10) == 0) return true; else return false;
  }
})();
</script>
</body>
</html>